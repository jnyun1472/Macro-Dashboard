<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Macro Dashboard (Numbers Only)</title>
  <!-- Tailwind (í”„ë¡œí† íƒ€ì…ìš© CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <!-- ìƒë‹¨: ì œëª© / API í‚¤ ì…ë ¥ -->
    <div class="w-full flex flex-col md:flex-row gap-3 items-start md:items-center justify-between p-4 bg-white/70 backdrop-blur rounded-xl shadow">
      <div>
        <h1 class="text-xl font-bold">Macro Dashboard</h1>
        <p class="text-sm text-neutral-500">ì°¨íŠ¸ ì—†ì´ ìˆ«ìë§Œ ê°„ë‹¨íˆ í‘œì‹œí•©ë‹ˆë‹¤. (FRED API í‚¤ í•„ìš”)</p>
      </div>
      <div class="flex items-center gap-2 w-full md:w-auto">
        <input id="apiKeyInput" type="password"
               class="w-full md:w-80 px-3 py-2 rounded-lg border border-neutral-300 bg-white"
               placeholder="FRED API Key" />
        <button id="saveBtn"
                class="px-4 py-2 rounded-lg bg-black text-white hover:opacity-90">ì €ì¥</button>
        <button id="refreshBtn"
                class="px-4 py-2 rounded-lg bg-neutral-800 text-white hover:opacity-90">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>

    <!-- ìƒíƒœ í‘œì‹œ -->
    <div class="mt-3 flex items-center justify-between">
      <div id="statusText" class="text-sm text-neutral-500">ëŒ€ê¸° ì¤‘â€¦</div>
      <div id="lastUpdated" class="text-sm text-neutral-500"></div>
    </div>

    <!-- API í‚¤ ì•ˆë‚´ -->
    <div id="noKeyBox" class="hidden mt-4 p-4 rounded-xl bg-amber-50 border border-amber-200 text-amber-900">
      FRED API í‚¤ë¥¼ ì…ë ¥í•˜ê³  <b>ì €ì¥</b>ì„ ëˆ„ë¥¸ ë’¤ <b>ìƒˆë¡œê³ ì¹¨</b>ì„ ëˆ„ë¥´ì„¸ìš”. (í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤)
    </div>

    <!-- ì—ëŸ¬ ë°•ìŠ¤ -->
    <div id="errorBox" class="hidden mt-4 p-3 rounded-lg bg-red-100 text-red-800"></div>

    <!-- ì§€í‘œ í…Œì´ë¸” -->
    <div class="mt-5 overflow-x-auto">
      <table class="w-full min-w-[820px] bg-white rounded-xl shadow border border-neutral-200">
        <thead>
          <tr class="text-xs text-neutral-500">
            <th class="text-left px-3 py-2">Indicator</th>
            <th class="text-right px-3 py-2">Latest</th>
            <th class="text-right px-3 py-2">Î” 1m</th>
            <th class="text-right px-3 py-2">Î” 3m</th>
            <th class="text-right px-3 py-2">As of</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="mt-4 text-xs text-neutral-500">
      Source: FRED API. í‘œì‹œ ê°’ì€ ìµœì‹  ê´€ì¸¡ì¹˜ ê¸°ì¤€ì´ë©°, ì›”/ì£¼/ì¼ ìë£ŒëŠ” ì„œë¡œ ë‹¤ë¥¸ ë¹ˆë„ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
  </div>

  <script type="module">
    // ===== ì„¤ì • =====
    const START_DATE = "2019-01-01";
    const LS_KEY = "FRED_API_KEY";

    // ìš”ì²­í•˜ì‹  ì „ì²´ ì§€í‘œ ì„¸íŠ¸ (ë¼ë²¨ì— ID ì œê±°)
    const INDICATORS = [
      // Macro & Rates
      { key: "PAYEMS", label: "NFP", desc: "Nonfarm Payrolls (thous)", type: "level", isPercent: false, frequencyHint: "monthly" },
      { key: "ICSA", label: "Initial Claims", desc: "Weekly Initial Jobless Claims", type: "level", isPercent: false, frequencyHint: "weekly" },
      { key: "AWHAEMAN", label: "Avg Hours â€“ Manufacturing", desc: "Manufacturing Average Weekly Hours", type: "level", isPercent: false, frequencyHint: "monthly" },
      { key: "NAPMNOI", label: "ISM New Orders", desc: "ISM Manufacturing New Orders Index", type: "level", isPercent: false, frequencyHint: "monthly" },
      { key: "CPIAUCSL", label: "CPI YoY", desc: "CPI (YoY, headline)", type: "yoy", isPercent: true, frequencyHint: "monthly" },
      { key: "T10YIE", label: "10Y Breakeven", desc: "10Y Inflation Expectation", type: "level", isPercent: true, frequencyHint: "daily" },
      { key: "DGS2", label: "2Y Yield", desc: "2-Year Treasury Yield (%)", type: "level", isPercent: true, frequencyHint: "daily" },
      { key: "DGS10", label: "10Y Yield", desc: "10-Year Treasury Yield (%)", type: "level", isPercent: true, frequencyHint: "daily" },
      { key: "SPREAD_10Y_2Y", label: "10Y - 2Y Spread", desc: "Term Spread (10Y minus 2Y)", type: "derived", isPercent: false, frequencyHint: "daily", base: ["DGS10", "DGS2"] },
      { key: "WALCL", label: "Fed Balance Sheet", desc: "Federal Reserve Total Assets ($bn)", type: "level", isPercent: false, frequencyHint: "weekly" },
      { key: "RRPONTSYD", label: "ON RRP Balance", desc: "Overnight Reverse Repo ($bn)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "BAMLH0A0HYM2", label: "HY OAS", desc: "High Yield OAS (bps)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "DTWEXBGS", label: "Dollar Index", desc: "Trade-Weighted Dollar Index", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "GOLDPMGBD228NLBM", label: "Gold PM Fix", desc: "London Gold PM Fix ($/oz)", type: "level", isPercent: false, frequencyHint: "daily" },
      // Equity Indices
      { key: "SP500", label: "S&P 500", desc: "S&P 500 Index (price)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "NASDAQCOM", label: "Nasdaq Composite", desc: "Nasdaq Composite Index", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "DJIA", label: "Dow Jones Industrial Avg", desc: "Dow Jones Industrial Average", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "WILL5000INDFC", label: "Wilshire 5000", desc: "Wilshire 5000 Total Market (Full Cap)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "VIXCLS", label: "VIX", desc: "CBOE Volatility Index", type: "level", isPercent: false, frequencyHint: "daily" },
    ];

    // ===== ìœ í‹¸ =====
    const $ = (sel) => document.querySelector(sel);
    function fmt(num, digits = 2) {
      if (num === null || num === undefined || Number.isNaN(num)) return "â€“";
      return Number(num).toLocaleString(undefined, { maximumFractionDigits: digits, minimumFractionDigits: digits });
    }
    function fmtDate(dStr) {
      if (!dStr) return "";
      const d = new Date(dStr);
      if (Number.isNaN(d.getTime())) return dStr;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function days(n) { return 24 * 60 * 60 * 1000 * n; }

    function valueAtOrBefore(observations, targetDate) {
      for (let i = observations.length - 1; i >= 0; i--) {
        const d = new Date(observations[i].date);
        if (d.getTime() <= targetDate.getTime()) return observations[i].value;
      }
      return null;
    }

    function yoyFrom(observations) {
      if (!observations || observations.length < 13) return null;
      const last = observations[observations.length - 1];
      const lastD = new Date(last.date);
      let prev12 = null;
      for (let i = observations.length - 2; i >= 0; i--) {
        const d = new Date(observations[i].date);
        if (d.getUTCFullYear() === lastD.getUTCFullYear() - 1 && d.getUTCMonth() === lastD.getUTCMonth()) {
          prev12 = observations[i].value;
          break;
        }
      }
      if (prev12 === null) return null;
      return (last.value / prev12 - 1) * 100;
    }

    // ğŸ”§ í”„ë¡ì‹œ (ì„ì‹œ/í…ŒìŠ¤íŠ¸ìš©)
    const USE_PROXY = true;
    const PROXY = 'https://api.allorigins.win/raw?url=';

    async function fetchFredSeries(seriesId, apiKey, start = START_DATE) {
      const fredUrl = "https://api.stlouisfed.org/fred/series/observations"
        + "?series_id=" + encodeURIComponent(seriesId)
        + "&api_key=" + encodeURIComponent(apiKey)
        + "&file_type=json"
        + "&observation_start=" + encodeURIComponent(start);

      const url = USE_PROXY ? (PROXY + encodeURIComponent(fredUrl)) : fredUrl;

      const res = await fetch(url);
      if (!res.ok) throw new Error("FRED fetch failed: " + seriesId);

      const json = await res.json();
      const obs = (json.observations || [])
        .filter(o => o.value !== "." && o.value !== null)
        .map(o => ({ date: o.date, value: parseFloat(o.value) }))
        .filter(o => !Number.isNaN(o.value));
      return obs;
    }

    // ë™ì¼ ë‚ ì§œë¡œ ë³‘í•©(ë‚´ì  ì¡°ì¸) â†’ 10Y-2Y ìŠ¤í”„ë ˆë“œ
    function mergeOnDate(a, b) {
      const mapB = new Map(b.map(p => [fmtDate(p.date), p.value]));
      const merged = [];
      for (const p of a) {
        const key = fmtDate(p.date);
        if (mapB.has(key)) merged.push({ date: key, value: p.value - mapB.get(key) });
      }
      return merged;
    }

    function computeDeltas(observations, mode /* 'level'|'yoy' */) {
      if (!observations || !observations.length) {
        return { latest: null, d1m: null, d3m: null, asOf: null, isPercent: false };
      }
      const latest = observations[observations.length - 1];
      const lastDate = new Date(latest.date);

      if (mode === "yoy") {
        return {
          latest: yoyFrom(observations),
          d1m: null,
          d3m: null,
          asOf: latest.date,
          isPercent: true
        };
      }

      const v1m = valueAtOrBefore(observations, new Date(lastDate.getTime() - days(30)));
      const v3m = valueAtOrBefore(observations, new Date(lastDate.getTime() - days(90)));
      return {
        latest: latest.value,
        d1m: v1m !== null ? latest.value - v1m : null,
        d3m: v3m !== null ? latest.value - v3m : null,
        asOf: latest.date,
        isPercent: false
      };
    }

    // ===== ë Œë”ë§ =====
    function renderRow(tbody, def, metrics) {
      const tr = document.createElement("tr");
      tr.className = "border-t border-neutral-100 hover:bg-neutral-50";

      const isPct = def.isPercent || metrics.isPercent;
      const latestStr = isPct
        ? (metrics.latest == null ? "â€“" : `${Number(metrics.latest).toFixed(1)}%`)
        : fmt(metrics.latest);

      const d1mStr = metrics.d1m === null ? "â€“" : (isPct ? `${Number(metrics.d1m).toFixed(2)}` : fmt(metrics.d1m));
      const d3mStr = metrics.d3m === null ? "â€“" : (isPct ? `${Number(metrics.d3m).toFixed(2)}` : fmt(metrics.d3m));
      const d1mClass = metrics.d1m > 0 ? "text-emerald-600" : metrics.d1m < 0 ? "text-rose-600" : "";
      const d3mClass = metrics.d3m > 0 ? "text-emerald-600" : metrics.d3m < 0 ? "text-rose-600" : "";

      tr.innerHTML = `
        <td class="px-3 py-3">
          <div class="font-medium">${def.label}</div>
          <div class="text-xs text-neutral-500">${def.desc}</div>
        </td>
        <td class="px-3 py-3 text-right font-semibold">${latestStr}</td>
        <td class="px-3 py-3 text-right font-semibold ${d1mClass}">${d1mStr}</td>
        <td class="px-3 py-3 text-right font-semibold ${d3mClass}">${d3mStr}</td>
        <td class="px-3 py-3 text-right text-xs text-neutral-500">${fmtDate(metrics.asOf)}</td>
      `;
      tbody.appendChild(tr);
    }

    async function loadAll() {
      const apiKey = localStorage.getItem(LS_KEY) || "";
      const status = $("#statusText");
      const errorBox = $("#errorBox");
      const noKeyBox = $("#noKeyBox");
      const tbody = $("#tbody");
      const lastUpdated = $("#lastUpdated");

      $("#apiKeyInput").value = apiKey;
      tbody.innerHTML = "";
      errorBox.classList.add("hidden");
      errorBox.textContent = "";

      if (!apiKey) {
        noKeyBox.classList.remove("hidden");
        status.textContent = "API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        lastUpdated.textContent = "";
        return;
      } else {
        noKeyBox.classList.add("hidden");
      }

      try {
        status.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";

        // 1) íŒŒìƒ ì œì™¸ ëª©ë¡ë§Œ í˜¸ì¶œ
        const baseDefs = INDICATORS.filter(d => d.type !== "derived");
        const baseIds = baseDefs.map(d => d.key);
        const fetched = await Promise.all(baseIds.map(id => fetchFredSeries(id, apiKey)));

        // 2) ë§µ êµ¬ì„±
        const map = {};
        baseIds.forEach((id, idx) => { map[id] = fetched[idx]; });

        // 3) íŒŒìƒ ìƒì„±: 10Y-2Y
        const d10 = map["DGS10"] || [];
        const d2  = map["DGS2"]  || [];
        if (d10.length && d2.length) {
          map["SPREAD_10Y_2Y"] = mergeOnDate(d10, d2);
        }

        // 4) ë Œë”
        INDICATORS.forEach(def => {
          const obs = map[def.key] || [];
          const m = computeDeltas(obs, def.type);
          // CPI YoY / DGS2 / DGS10 / T10YIEëŠ” í¼ì„¼íŠ¸ë¡œ í‘œê¸°
          m.isPercent = def.isPercent || m.isPercent;
          renderRow(tbody, def, m);
        });

        status.textContent = "ì™„ë£Œ";
        lastUpdated.textContent = new Date().toLocaleString(undefined, { hour12: false });
      } catch (e) {
        status.textContent = "ì˜¤ë¥˜";
        errorBox.textContent = "ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + (e.message || String(e)) + " (API í‚¤ì™€ ë„¤íŠ¸ì›Œí¬/CORSë¥¼ í™•ì¸í•˜ì„¸ìš”)";
        errorBox.classList.remove("hidden");
      }
    }

    // ===== ì´ë²¤íŠ¸ =====
    $("#saveBtn").addEventListener("click", () => {
      const v = $("#apiKeyInput").value.trim();
      if (!v) return;
      localStorage.setItem(LS_KEY, v);
      alert("API í‚¤ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ì´ì œ 'ìƒˆë¡œê³ ì¹¨'ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
    });
    $("#refreshBtn").addEventListener("click", loadAll);

    // ì´ˆê¸° ë¡œë“œ
    (function init(){
      const saved = localStorage.getItem(LS_KEY) || "";
      $("#apiKeyInput").value = saved;
      $("#lastUpdated").textContent = new Date().toLocaleString(undefined, { hour12: false });
      if (saved) loadAll();
      else $("#noKeyBox").classList.remove("hidden");
    })();
  </script>
</body>
</html>
