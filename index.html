<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Macro Dashboard (Numbers Only)</title>
  <!-- Tailwind (프로토타입용 CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <!-- 상단: 제목 / API 키 입력 -->
    <div class="w-full flex flex-col md:flex-row gap-3 items-start md:items-center justify-between p-4 bg-white/70 backdrop-blur rounded-xl shadow">
      <div>
        <h1 class="text-xl font-bold">Macro Dashboard</h1>
        <p class="text-sm text-neutral-500">차트 없이 숫자만 간단히 표시합니다. (FRED API 키 필요)</p>
      </div>
      <div class="flex items-center gap-2 w-full md:w-auto">
        <input id="apiKeyInput" type="password"
               class="w-full md:w-80 px-3 py-2 rounded-lg border border-neutral-300 bg-white"
               placeholder="FRED API Key" />
        <button id="saveBtn"
                class="px-4 py-2 rounded-lg bg-black text-white hover:opacity-90">저장</button>
        <button id="refreshBtn"
                class="px-4 py-2 rounded-lg bg-neutral-800 text-white hover:opacity-90">새로고침</button>
      </div>
    </div>

    <!-- 상태 표시 -->
    <div class="mt-3 flex items-center justify-between">
      <div id="statusText" class="text-sm text-neutral-500">대기 중…</div>
      <div id="lastUpdated" class="text-sm text-neutral-500"></div>
    </div>

    <!-- API 키 안내 -->
    <div id="noKeyBox" class="hidden mt-4 p-4 rounded-xl bg-amber-50 border border-amber-200 text-amber-900">
      FRED API 키를 입력하고 <b>저장</b>을 누른 뒤 <b>새로고침</b>을 누르세요. (키는 브라우저에만 저장됩니다)
    </div>

    <!-- 에러 박스 -->
    <div id="errorBox" class="hidden mt-4 p-3 rounded-lg bg-red-100 text-red-800"></div>

    <!-- 지표 테이블 -->
    <div class="mt-5 overflow-x-auto">
      <table class="w-full min-w-[820px] bg-white rounded-xl shadow border border-neutral-200">
        <thead>
          <tr class="text-xs text-neutral-500">
            <th class="text-left px-3 py-2">Indicator</th>
            <th class="text-right px-3 py-2">Latest</th>
            <th class="text-right px-3 py-2">Δ 1m</th>
            <th class="text-right px-3 py-2">Δ 3m</th>
            <th class="text-right px-3 py-2">As of</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="mt-4 text-xs text-neutral-500">
      Source: FRED API. 표시 값은 최신 관측치 기준이며, 월/주/일 자료는 서로 다른 빈도를 가질 수 있습니다.
    </div>
  </div>

  <script type="module">
    // ===== 설정 =====
    const START_DATE = "2019-01-01";
    const LS_KEY = "FRED_API_KEY";

    // 요청하신 전체 지표 세트 (라벨에 ID 제거)
    const INDICATORS = [
      // Macro & Rates
      { key: "PAYEMS", label: "NFP", desc: "Nonfarm Payrolls (thous)", type: "level", isPercent: false, frequencyHint: "monthly" },
      { key: "ICSA", label: "Initial Claims", desc: "Weekly Initial Jobless Claims", type: "level", isPercent: false, frequencyHint: "weekly" },
      { key: "AWHAEMAN", label: "Avg Hours – Manufacturing", desc: "Manufacturing Average Weekly Hours", type: "level", isPercent: false, frequencyHint: "monthly" },
      { key: "NAPMNOI", label: "ISM New Orders", desc: "ISM Manufacturing New Orders Index", type: "level", isPercent: false, frequencyHint: "monthly" },
      { key: "CPIAUCSL", label: "CPI YoY", desc: "CPI (YoY, headline)", type: "yoy", isPercent: true, frequencyHint: "monthly" },
      { key: "T10YIE", label: "10Y Breakeven", desc: "10Y Inflation Expectation", type: "level", isPercent: true, frequencyHint: "daily" },
      { key: "DGS2", label: "2Y Yield", desc: "2-Year Treasury Yield (%)", type: "level", isPercent: true, frequencyHint: "daily" },
      { key: "DGS10", label: "10Y Yield", desc: "10-Year Treasury Yield (%)", type: "level", isPercent: true, frequencyHint: "daily" },
      { key: "SPREAD_10Y_2Y", label: "10Y - 2Y Spread", desc: "Term Spread (10Y minus 2Y)", type: "derived", isPercent: false, frequencyHint: "daily", base: ["DGS10", "DGS2"] },
      { key: "WALCL", label: "Fed Balance Sheet", desc: "Federal Reserve Total Assets ($bn)", type: "level", isPercent: false, frequencyHint: "weekly" },
      { key: "RRPONTSYD", label: "ON RRP Balance", desc: "Overnight Reverse Repo ($bn)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "BAMLH0A0HYM2", label: "HY OAS", desc: "High Yield OAS (bps)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "DTWEXBGS", label: "Dollar Index", desc: "Trade-Weighted Dollar Index", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "GOLDPMGBD228NLBM", label: "Gold PM Fix", desc: "London Gold PM Fix ($/oz)", type: "level", isPercent: false, frequencyHint: "daily" },
      // Equity Indices
      { key: "SP500", label: "S&P 500", desc: "S&P 500 Index (price)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "NASDAQCOM", label: "Nasdaq Composite", desc: "Nasdaq Composite Index", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "DJIA", label: "Dow Jones Industrial Avg", desc: "Dow Jones Industrial Average", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "WILL5000INDFC", label: "Wilshire 5000", desc: "Wilshire 5000 Total Market (Full Cap)", type: "level", isPercent: false, frequencyHint: "daily" },
      { key: "VIXCLS", label: "VIX", desc: "CBOE Volatility Index", type: "level", isPercent: false, frequencyHint: "daily" },
    ];

    // ===== 유틸 =====
    const $ = (sel) => document.querySelector(sel);
    function fmt(num, digits = 2) {
      if (num === null || num === undefined || Number.isNaN(num)) return "–";
      return Number(num).toLocaleString(undefined, { maximumFractionDigits: digits, minimumFractionDigits: digits });
    }
    function fmtDate(dStr) {
      if (!dStr) return "";
      const d = new Date(dStr);
      if (Number.isNaN(d.getTime())) return dStr;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function days(n) { return 24 * 60 * 60 * 1000 * n; }

    function valueAtOrBefore(observations, targetDate) {
      for (let i = observations.length - 1; i >= 0; i--) {
        const d = new Date(observations[i].date);
        if (d.getTime() <= targetDate.getTime()) return observations[i].value;
      }
      return null;
    }

    function yoyFrom(observations) {
      if (!observations || observations.length < 13) return null;
      const last = observations[observations.length - 1];
      const lastD = new Date(last.date);
      let prev12 = null;
      for (let i = observations.length - 2; i >= 0; i--) {
        const d = new Date(observations[i].date);
        if (d.getUTCFullYear() === lastD.getUTCFullYear() - 1 && d.getUTCMonth() === lastD.getUTCMonth()) {
          prev12 = observations[i].value;
          break;
        }
      }
      if (prev12 === null) return null;
      return (last.value / prev12 - 1) * 100;
    }

    <script type="module">

    // ✅ 멀티 프록시 폴백 (순서대로 시도)
    const PROXIES = [
      (u) => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
      (u) => 'https://cors.isomorphic-git.org/' + u,
      (u) => 'https://corsproxy.io/?' + encodeURIComponent(u),
      (u) => 'https://thingproxy.freeboard.io/fetch/' + u,
    ];
  
    async function tryFetch(url) {
      const res = await fetch(url, { cache: 'no-store', mode: 'cors', redirect: 'follow' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res;
    }
  
    async function fetchWithFallback(fredUrl) {
      // 1) 직결 시도
      try { return await tryFetch(fredUrl); }
      catch (e) { console.warn('[FRED] direct fetch failed:', e); }
  
      // 2) 프록시 순차 시도
      for (const make of PROXIES) {
        const proxied = make(fredUrl);
        try {
          const r = await tryFetch(proxied);
          console.info('[FRED] using proxy:', proxied.split('/')[2]);
          return r;
        } catch (e) {
          console.warn('[FRED] proxy failed:', proxied.split('/')[2], e);
        }
      }
      throw new Error('Failed to fetch (all routes). CORS/네트워크 문제일 수 있습니다.');
    }
  
    async function fetchFredSeries(seriesId, apiKey, start = START_DATE) {
      const fredUrl =
        'https://api.stlouisfed.org/fred/series/observations'
        + '?series_id=' + encodeURIComponent(seriesId)
        + '&api_key=' + encodeURIComponent(apiKey)
        + '&file_type=json'
        + '&observation_start=' + encodeURIComponent(start);
  
      // ⬇️ 여기서 폴백 포함 요청
      const res = await fetchWithFallback(fredUrl);
  
      const json = await res.json();
      const obs = (json.observations || [])
        .filter(o => o.value !== '.' && o.value !== null)
        .map(o => ({ date: o.date, value: parseFloat(o.value) }))
        .filter(o => !Number.isNaN(o.value));
  
      return obs;
    }

    // 동일 날짜로 병합(내적 조인) → 10Y-2Y 스프레드
    function mergeOnDate(a, b) {
      const mapB = new Map(b.map(p => [fmtDate(p.date), p.value]));
      const merged = [];
      for (const p of a) {
        const key = fmtDate(p.date);
        if (mapB.has(key)) merged.push({ date: key, value: p.value - mapB.get(key) });
      }
      return merged;
    }

    function computeDeltas(observations, mode /* 'level'|'yoy' */) {
      if (!observations || !observations.length) {
        return { latest: null, d1m: null, d3m: null, asOf: null, isPercent: false };
      }
      const latest = observations[observations.length - 1];
      const lastDate = new Date(latest.date);

      if (mode === "yoy") {
        return {
          latest: yoyFrom(observations),
          d1m: null,
          d3m: null,
          asOf: latest.date,
          isPercent: true
        };
      }

      const v1m = valueAtOrBefore(observations, new Date(lastDate.getTime() - days(30)));
      const v3m = valueAtOrBefore(observations, new Date(lastDate.getTime() - days(90)));
      return {
        latest: latest.value,
        d1m: v1m !== null ? latest.value - v1m : null,
        d3m: v3m !== null ? latest.value - v3m : null,
        asOf: latest.date,
        isPercent: false
      };
    }

    // ===== 렌더링 =====
    function renderRow(tbody, def, metrics) {
      const tr = document.createElement("tr");
      tr.className = "border-t border-neutral-100 hover:bg-neutral-50";

      const isPct = def.isPercent || metrics.isPercent;
      const latestStr = isPct
        ? (metrics.latest == null ? "–" : `${Number(metrics.latest).toFixed(1)}%`)
        : fmt(metrics.latest);

      const d1mStr = metrics.d1m === null ? "–" : (isPct ? `${Number(metrics.d1m).toFixed(2)}` : fmt(metrics.d1m));
      const d3mStr = metrics.d3m === null ? "–" : (isPct ? `${Number(metrics.d3m).toFixed(2)}` : fmt(metrics.d3m));
      const d1mClass = metrics.d1m > 0 ? "text-emerald-600" : metrics.d1m < 0 ? "text-rose-600" : "";
      const d3mClass = metrics.d3m > 0 ? "text-emerald-600" : metrics.d3m < 0 ? "text-rose-600" : "";

      tr.innerHTML = `
        <td class="px-3 py-3">
          <div class="font-medium">${def.label}</div>
          <div class="text-xs text-neutral-500">${def.desc}</div>
        </td>
        <td class="px-3 py-3 text-right font-semibold">${latestStr}</td>
        <td class="px-3 py-3 text-right font-semibold ${d1mClass}">${d1mStr}</td>
        <td class="px-3 py-3 text-right font-semibold ${d3mClass}">${d3mStr}</td>
        <td class="px-3 py-3 text-right text-xs text-neutral-500">${fmtDate(metrics.asOf)}</td>
      `;
      tbody.appendChild(tr);
    }

    async function loadAll() {
      const apiKey = localStorage.getItem(LS_KEY) || "";
      const status = $("#statusText");
      const errorBox = $("#errorBox");
      const noKeyBox = $("#noKeyBox");
      const tbody = $("#tbody");
      const lastUpdated = $("#lastUpdated");

      $("#apiKeyInput").value = apiKey;
      tbody.innerHTML = "";
      errorBox.classList.add("hidden");
      errorBox.textContent = "";

      if (!apiKey) {
        noKeyBox.classList.remove("hidden");
        status.textContent = "API 키를 입력하세요.";
        lastUpdated.textContent = "";
        return;
      } else {
        noKeyBox.classList.add("hidden");
      }

      try {
        status.textContent = "불러오는 중…";

        // 1) 파생 제외 목록만 호출
        const baseDefs = INDICATORS.filter(d => d.type !== "derived");
        const baseIds = baseDefs.map(d => d.key);
        const fetched = await Promise.all(baseIds.map(id => fetchFredSeries(id, apiKey)));

        // 2) 맵 구성
        const map = {};
        baseIds.forEach((id, idx) => { map[id] = fetched[idx]; });

        // 3) 파생 생성: 10Y-2Y
        const d10 = map["DGS10"] || [];
        const d2  = map["DGS2"]  || [];
        if (d10.length && d2.length) {
          map["SPREAD_10Y_2Y"] = mergeOnDate(d10, d2);
        }

        // 4) 렌더
        INDICATORS.forEach(def => {
          const obs = map[def.key] || [];
          const m = computeDeltas(obs, def.type);
          // CPI YoY / DGS2 / DGS10 / T10YIE는 퍼센트로 표기
          m.isPercent = def.isPercent || m.isPercent;
          renderRow(tbody, def, m);
        });

        status.textContent = "완료";
        lastUpdated.textContent = new Date().toLocaleString(undefined, { hour12: false });
      } catch (e) {
        status.textContent = "오류";
        errorBox.textContent = "데이터 로드 중 오류: " + (e.message || String(e)) + " (API 키와 네트워크/CORS를 확인하세요)";
        errorBox.classList.remove("hidden");
      }
    }

    // ===== 이벤트 =====
    $("#saveBtn").addEventListener("click", () => {
      const v = $("#apiKeyInput").value.trim();
      if (!v) return;
      localStorage.setItem(LS_KEY, v);
      alert("API 키를 저장했습니다. 이제 '새로고침'을 눌러 데이터를 불러오세요.");
    });
    $("#refreshBtn").addEventListener("click", loadAll);

    // 초기 로드
    (function init(){
      const saved = localStorage.getItem(LS_KEY) || "";
      $("#apiKeyInput").value = saved;
      $("#lastUpdated").textContent = new Date().toLocaleString(undefined, { hour12: false });
      if (saved) loadAll();
      else $("#noKeyBox").classList.remove("hidden");
    })();
  </script>
</body>
</html>
