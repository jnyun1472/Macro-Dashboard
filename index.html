<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Macro Dashboard (Numbers Only)</title>
  <!-- Tailwind (í”„ë¡œí† íƒ€ì…ìš© CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <!-- ìƒë‹¨: ì œëª© / API í‚¤ ì…ë ¥ -->
    <div class="w-full flex flex-col md:flex-row gap-3 items-start md:items-center justify-between p-4 bg-white/70 backdrop-blur rounded-xl shadow">
      <div>
        <h1 class="text-xl font-bold">Macro Dashboard</h1>
        <p class="text-sm text-neutral-500">ì°¨íŠ¸ ì—†ì´ ìˆ«ìë§Œ ê°„ë‹¨íˆ í‘œì‹œí•©ë‹ˆë‹¤. (FRED API í‚¤ í•„ìš”)</p>
      </div>
      <div class="flex items-center gap-2 w-full md:w-auto">
        <input id="apiKeyInput" type="password"
               class="w-full md:w-80 px-3 py-2 rounded-lg border border-neutral-300 bg-white"
               placeholder="FRED API Key" />
        <button id="saveBtn"
                class="px-4 py-2 rounded-lg bg-black text-white hover:opacity-90">ì €ì¥</button>
        <button id="refreshBtn"
                class="px-4 py-2 rounded-lg bg-neutral-800 text-white hover:opacity-90">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>

    <!-- ìƒíƒœ í‘œì‹œ -->
    <div class="mt-3 flex items-center justify-between">
      <div id="statusText" class="text-sm text-neutral-500">ëŒ€ê¸° ì¤‘â€¦</div>
      <div id="lastUpdated" class="text-sm text-neutral-500"></div>
    </div>

    <!-- API í‚¤ ì•ˆë‚´ -->
    <div id="noKeyBox" class="hidden mt-4 p-4 rounded-xl bg-amber-50 border border-amber-200 text-amber-900">
      FRED API í‚¤ë¥¼ ì…ë ¥í•˜ê³  <b>ì €ì¥</b>ì„ ëˆ„ë¥¸ ë’¤ <b>ìƒˆë¡œê³ ì¹¨</b>ì„ ëˆ„ë¥´ì„¸ìš”. (í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤)
    </div>

    <!-- ì—ëŸ¬ ë°•ìŠ¤ -->
    <div id="errorBox" class="hidden mt-4 p-3 rounded-lg bg-red-100 text-red-800"></div>

    <!-- ì§€í‘œ í…Œì´ë¸” -->
    <div class="mt-5 overflow-x-auto">
      <table class="w-full min-w-[720px] bg-white rounded-xl shadow border border-neutral-200">
        <thead>
          <tr class="text-xs text-neutral-500">
            <th class="text-left px-3 py-2">Indicator</th>
            <th class="text-right px-3 py-2">Latest</th>
            <th class="text-right px-3 py-2">Î” 1m</th>
            <th class="text-right px-3 py-2">Î” 3m</th>
            <th class="text-right px-3 py-2">As of</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="mt-4 text-xs text-neutral-500">
      Source: FRED API. í‘œì‹œ ê°’ì€ ìµœì‹  ê´€ì¸¡ì¹˜ ê¸°ì¤€ì´ë©°, ì›”/ì£¼/ì¼ ìë£ŒëŠ” ì„œë¡œ ë‹¤ë¥¸ ë¹ˆë„ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
  </div>

  <script type="module">
    // ===== ì„¤ì • =====
    const START_DATE = "2019-01-01";
    const LS_KEY = "FRED_API_KEY";

    // ìµœì†Œ ì…‹ìœ¼ë¡œ ì‹œì‘ (ì›í•˜ì‹œë©´ ë‚˜ì¤‘ì— ì¶”ê°€)
    const INDICATORS = [
      // label, desc, key, type('level'|'yoy'), isPercent
      { key: "CPIAUCSL", label: "CPI YoY", desc: "ë¯¸êµ­ CPI (ì „ë…„ë™ì›” ëŒ€ë¹„)", type: "yoy", isPercent: true },
      { key: "DGS10",    label: "10Y Yield", desc: "ë¯¸ êµ­ì±„ 10ë…„ë¬¼ ìˆ˜ìµë¥ (%)", type: "level", isPercent: true },
      { key: "SP500",    label: "S&P 500", desc: "S&P 500 ì§€ìˆ˜(ê°€ê²©)", type: "level", isPercent: false },
      { key: "GOLDPMGBD228NLBM", label: "Gold PM Fix", desc: "ëŸ°ë˜ ê¸ˆ(ì˜¤ì „ ê³ ì‹œê°€, $/oz)", type: "level", isPercent: false },
      { key: "DTWEXBGS", label: "Dollar Index", desc: "ë¯¸ ë‹¬ëŸ¬(TW) ì§€ìˆ˜", type: "level", isPercent: false },
      { key: "PAYEMS",   label: "NFP", desc: "ë¹„ë†ì—… ë¶€ë¬¸ ê³ ìš©(ì²œ ëª…)", type: "level", isPercent: false },
      { key: "ICSA",     label: "Initial Claims", desc: "ì‹ ê·œ ì‹¤ì—…ìˆ˜ë‹¹ ì²­êµ¬(ì£¼ê°„)", type: "level", isPercent: false },
    ];

    // ===== ìœ í‹¸ =====
    const $ = (sel) => document.querySelector(sel);
    function fmt(num, digits = 2) {
      if (num === null || num === undefined || Number.isNaN(num)) return "â€“";
      return Number(num).toLocaleString(undefined, { maximumFractionDigits: digits, minimumFractionDigits: digits });
    }
    function fmtDate(dStr) {
      if (!dStr) return "";
      const d = new Date(dStr);
      if (Number.isNaN(d.getTime())) return dStr;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function days(n) { return 24 * 60 * 60 * 1000 * n; }

    function valueAtOrBefore(observations, targetDate) {
      for (let i = observations.length - 1; i >= 0; i--) {
        const d = new Date(observations[i].date);
        if (d.getTime() <= targetDate.getTime()) return observations[i].value;
      }
      return null;
    }
    function yoyFrom(observations) {
      if (!observations || observations.length < 13) return null;
      const last = observations[observations.length - 1];
      const lastD = new Date(last.date);
      let prev12 = null;
      for (let i = observations.length - 2; i >= 0; i--) {
        const d = new Date(observations[i].date);
        if (d.getUTCFullYear() === lastD.getUTCFullYear() - 1 && d.getUTCMonth() === lastD.getUTCMonth()) {
          prev12 = observations[i].value;
          break;
        }
      }
      if (prev12 === null) return null;
      return (last.value / prev12 - 1) * 100;
    }

    // ğŸ”§ ì¶”ê°€: í”„ë¡ì‹œ ì„¤ì • (ì„ì‹œìš©)
    const USE_PROXY = true;
    // ê³µê°œ í”„ë¡ì‹œ(ì„ì‹œ/í…ŒìŠ¤íŠ¸ìš©): ì„œë²„ê°€ ëŒ€ì‹  FREDì— ìš”ì²­í•˜ê³  CORS í—ˆìš© í—¤ë”ë¥¼ ë¶™ì—¬ ì¤ë‹ˆë‹¤.
    const PROXY = 'https://api.allorigins.win/raw?url=';
    
    async function fetchFredSeries(seriesId, apiKey, start = START_DATE) {
      const fredUrl = "https://api.stlouisfed.org/fred/series/observations"
        + "?series_id=" + encodeURIComponent(seriesId)
        + "&api_key=" + encodeURIComponent(apiKey)
        + "&file_type=json"
        + "&observation_start=" + encodeURIComponent(start);
    
      // âœ… í”„ë¡ì‹œë¥¼ í†µí•´ í˜¸ì¶œ (ë¸Œë¼ìš°ì €â†’í”„ë¡ì‹œâ†’FRED)
      const url = USE_PROXY ? (PROXY + encodeURIComponent(fredUrl)) : fredUrl;
    
      const res = await fetch(url);
      if (!res.ok) throw new Error("FRED fetch failed: " + seriesId);
    
      const json = await res.json();
      const obs = (json.observations || [])
        .filter(o => o.value !== "." && o.value !== null)
        .map(o => ({ date: o.date, value: parseFloat(o.value) }))
        .filter(o => !Number.isNaN(o.value));
      return obs;
    }

    function computeDeltas(observations, mode /* 'level'|'yoy' */) {
      if (!observations || !observations.length) {
        return { latest: null, d1m: null, d3m: null, asOf: null };
      }
      const latest = observations[observations.length - 1];
      const lastDate = new Date(latest.date);

      if (mode === "yoy") {
        // YoYëŠ” ë¸íƒ€ ëŒ€ì‹  %ë§Œ í‘œì‹œ
        return {
          latest: yoyFrom(observations),
          d1m: null,
          d3m: null,
          asOf: latest.date,
          isPercent: true
        };
      }

      const v1m = valueAtOrBefore(observations, new Date(lastDate.getTime() - days(30)));
      const v3m = valueAtOrBefore(observations, new Date(lastDate.getTime() - days(90)));
      return {
        latest: latest.value,
        d1m: v1m !== null ? latest.value - v1m : null,
        d3m: v3m !== null ? latest.value - v3m : null,
        asOf: latest.date
      };
    }

    // ===== ë Œë”ë§ =====
    function renderRow(tbody, def, metrics) {
      const tr = document.createElement("tr");
      tr.className = "border-t border-neutral-100 hover:bg-neutral-50";
      const latestStr = (def.isPercent || metrics.isPercent)
        ? (metrics.latest === null ? "â€“" : `${Number(metrics.latest).toFixed(1)}%`)
        : fmt(metrics.latest);

      const d1mStr = metrics.d1m === null ? "â€“" : (def.isPercent ? `${Number(metrics.d1m).toFixed(2)}` : fmt(metrics.d1m));
      const d3mStr = metrics.d3m === null ? "â€“" : (def.isPercent ? `${Number(metrics.d3m).toFixed(2)}` : fmt(metrics.d3m));
      const d1mClass = metrics.d1m > 0 ? "text-emerald-600" : metrics.d1m < 0 ? "text-rose-600" : "";
      const d3mClass = metrics.d3m > 0 ? "text-emerald-600" : metrics.d3m < 0 ? "text-rose-600" : "";

      tr.innerHTML = `
        <td class="px-3 py-3">
          <div class="font-medium">${def.label}</div>
          <div class="text-xs text-neutral-500">${def.desc}</div>
        </td>
        <td class="px-3 py-3 text-right font-semibold">${latestStr}</td>
        <td class="px-3 py-3 text-right font-semibold ${d1mClass}">${d1mStr}</td>
        <td class="px-3 py-3 text-right font-semibold ${d3mClass}">${d3mStr}</td>
        <td class="px-3 py-3 text-right text-xs text-neutral-500">${fmtDate(metrics.asOf)}</td>
      `;
      tbody.appendChild(tr);
    }

    async function loadAll() {
      const apiKey = localStorage.getItem(LS_KEY) || "";
      const status = $("#statusText");
      const errorBox = $("#errorBox");
      const noKeyBox = $("#noKeyBox");
      const tbody = $("#tbody");
      const lastUpdated = $("#lastUpdated");

      $("#apiKeyInput").value = apiKey;
      tbody.innerHTML = "";
      errorBox.classList.add("hidden");
      errorBox.textContent = "";

      if (!apiKey) {
        noKeyBox.classList.remove("hidden");
        status.textContent = "API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        lastUpdated.textContent = "";
        return;
      } else {
        noKeyBox.classList.add("hidden");
      }

      try {
        status.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
        const all = await Promise.all(INDICATORS.map(d => fetchFredSeries(d.key, apiKey)));
        all.forEach((obs, i) => {
          const def = INDICATORS[i];
          const m = computeDeltas(obs, def.type);
          renderRow(tbody, def, m);
        });
        status.textContent = "ì™„ë£Œ";
        lastUpdated.textContent = new Date().toLocaleString(undefined, { hour12: false });
      } catch (e) {
        status.textContent = "ì˜¤ë¥˜";
        errorBox.textContent = "ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + (e.message || String(e)) + " (API í‚¤ì™€ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”)";
        errorBox.classList.remove("hidden");
      }
    }

    // ===== ì´ë²¤íŠ¸ =====
    $("#saveBtn").addEventListener("click", () => {
      const v = $("#apiKeyInput").value.trim();
      if (!v) return;
      localStorage.setItem(LS_KEY, v);
      alert("API í‚¤ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ì´ì œ 'ìƒˆë¡œê³ ì¹¨'ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
    });
    $("#refreshBtn").addEventListener("click", loadAll);

    // ì´ˆê¸° ë¡œë“œ
    loadAll();
  </script>
</body>
</html>
